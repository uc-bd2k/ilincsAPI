---
title: "iLINCS API R Notebook"
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
---

## Prerequisites 

```{r}
library(httr)
library(jsonlite)
```

## Display Signature Libraries

```{r}
apiUrl <- "http://www.ilincs.org/api/SignatureLibraries"
req <- GET(apiUrl)
# content(r)
# l <- lapply(content(r)$data, function(x) unlist(x))
# ilincs_result <- data.frame(t(sapply(l,c)))
# knitr::kable(t(ilincs_result))
json <- httr::content(req, as = "text")
# json
ilincs_libraries <- fromJSON(json)
# knitr::kable(
  ilincs_libraries[,c("libraryID","libraryName")]
```

## Searching for signature using BROAD ID

**Example :** CPC004_A375_6H:BRD-K08252256-236-17-1:10
```{r}
term <- "CPC004_A375_6H:BRD-K08252256-236-17-1:10"
# term <- "MTOR"
apiUrl <- paste("http://www.ilincs.org/api/SignatureMeta/findTermWithSynonyms?term=",term,"&library=LIB_5",sep="")
req <- GET(apiUrl)
# content(r.data)
# l <- lapply(content(r)$data, function(x) unlist(x))
# ilincs_result <- data.frame(t(sapply(l,c)))
# # ilincs_result
# knitr::kable(t(ilincs_result))
ilincs_result <- httr::content(req)$data
dim(ilincs_result)
ilincs_result[[1]]
# ilincs_libraries[,c("libraryID","libraryName")]
ilincs_signatureId <- ilincs_result[[1]]$signatureid
ilincs_signatureId

```


## Retriving Signature Metadata
```{r}
# r <- POST("http://www.ilincs.org/api/SignatureMeta/uploadAndAnalyze?lib=LIB_5", body = list(file = upload_file(ftemp)))
# r <- GET("http://www.ilincs.org/api/SignatureMeta/LINCSCP_100")
apiUrl <- paste("http://www.ilincs.org/api/SignatureMeta/",ilincs_signatureId,sep="")
r <- GET(apiUrl)
# r
# content(r)
l <- lapply(content(r), function(x) unlist(x))
ilincs_result <- data.frame(t(sapply(l,c)))
knitr::kable(t(ilincs_result))
```

## Downloading signature data
```{r}
class(paste(ilincs_signatureId))

r <- POST("http://www.ilincs.org/api/ilincsR/downloadSignature", body = list(sigID = paste(ilincs_signatureId)), encode = "json")
l <- lapply(content(r), function(x) unlist(x))
ilincs_result <- data.frame(t(sapply(l,c)))
knitr::kable(t(ilincs_result))
ilincs_sessionId <- ilincs_result$data
ilincs_sessionId
```

## Getting volcano plot
```{r}
apiUrl <- paste("http://www.ilincs.org/api/ilincsR/volcanoPlot?file=",ilincs_sessionId,".xls",sep="")
apiUrl
r <- GET(apiUrl)
l <- lapply(content(r), function(x) unlist(x))
ilincs_result <- data.frame(t(sapply(l,c)))
knitr::kable(t(ilincs_result))
ilincs_volcanoUrl <- ilincs_result$url
ilincs_volcanoUrl <- paste("http://www.ilincs.org",ilincs_volcanoUrl,sep="")
ilincs_volcanoUrl
```

```{r echo=FALSE, out.width='100%'}
# knitr::include_graphics('http://eh3.uc.edu/tmp/gseaPlot_Fri_Nov_16_16_38_16_2018_257492.png')
knitr::include_graphics(ilincs_volcanoUrl)
```

## Get connected signatures

http://www.ilincs.org/api/SignatureMeta/findConcordantSignatures?sigID=LINCSKD_1&lib=LIB_5

## Get connected perturbations

http://www.ilincs.org/api/ilincsR/signatureEnrichment?sigFile=sig_Tue_Nov_27_13_21_36_2018_9007331.xls&library=LIB_5

## Get connected perturbations

http://www.ilincs.org/api/ilincsR/signatureEnrichment?sigFile=sig_Tue_Nov_27_13_21_36_2018_9007331.xls&library=LIB_5

## Get correlation plot
http://www.ilincs.org/api/ilincsR/correlationPlot?sigID=LINCSCP_10270&sigFile=sig_Tue_Nov_27_13_21_36_2018_9007331.xls

```{r}
apiUrl <- "http://www.ilincs.org/api/ilincsR/correlationPlot?sigID=LINCSCP_10270&sigFile=sig_Tue_Nov_27_13_21_36_2018_9007331.xls"
# req <- GET(apiUrl)
# json <- httr::content(req, as = "text")
# json <- fromJSON(apiUrl)
# all.equal(plot, toJSON(fromJSON(apiUrl)))
json <- toJSON(fromJSON(apiUrl))
prettify(json)
class(json)

# # correlation_plot <- fromJSON(json)
# correlation_plot
```

---
title: "iLINCS API R Notebook"
output:
  html_document:
    df_print: paged
  html_notebook: default
  word_document: default
  pdf_document: default
---

<!-- ## Prerequisites  -->

```{r include = FALSE}
library(knitr)
library(tinytex)
library(httr)
library(jsonlite)
library(plotly)
library(htmltools)

getOutputFormat <- function() {
  output <- rmarkdown:::parse_yaml_front_matter(
    readLines(knitr::current_input())
    )$output
  if (is.list(output)){
    return(names(output)[1])
  } else {
    return(output[1])
  }
}
```


## Display Signature Libraries

```{r}
apiUrl <- "http://www.ilincs.org/api/SignatureLibraries"
req <- GET(apiUrl)
json <- httr::content(req, as = "text")
ilincs_libraries <- fromJSON(json)
ilincs_libraries[,c("libraryID","libraryName")]
```

## Searching for signature using BROAD ID

Searching for signature for given term. In this example "Diclofenac" coumpound will be shown as an example.

**Term :** Diclofenac
```{r}
term <- "Diclofenac"
apiUrl <- paste("http://www.ilincs.org/api/SignatureMeta/findTermWithSynonyms?term=",term,"&library=LIB_5",sep="")
req <- GET(apiUrl)
ilincs_result <- httr::content(req)$data
# ilincs_result[[1]]
# knitr::kable(t(ilincs_result[[1]]))
```

Extracting signature ID of the signature with the highest connectivity

```{r selectedSignature}
ilincs_signatureId <- ilincs_result[[1]]$signatureid
ilincs_signatureId
```

[`r ilincs_signatureId` signature page on iLINCS](http://www.ilincs.org/ilincs/signature/`r ilincs_signatureId`)

## Retriving Signature Metadata
```{r}
apiUrl <- paste("http://www.ilincs.org/api/SignatureMeta/",ilincs_signatureId,sep="")
req <- GET(apiUrl)
l <- lapply(content(req), function(x) unlist(x))
ilincs_result <- data.frame(t(sapply(l,c)))
knitr::kable(t(ilincs_result))
```

## Downloading signature data
```{r}
# class(paste(ilincs_signatureId))
r <- POST("http://www.ilincs.org/api/ilincsR/downloadSignature", body = list(sigID = paste(ilincs_signatureId),display = TRUE), encode = "json")
# l <- lapply(content(r), function(x) unlist(x))
# ilincs_result <- data.frame(t(sapply(l,c)))
# knitr::kable(t(ilincs_result))
ilincs_result <- content(r)$data
ilincs_sessionId <- ilincs_result$fileName
l <- lapply(ilincs_result$signature, function(x) unlist(x))
ilincs_signatureData <- data.frame(t(sapply(l,c)))
# ilincs_signatureData
ilincs_signatureData$Value_LogDiffExp <- as.numeric(as.character(ilincs_signatureData$Value_LogDiffExp))
ilincs_signatureData$Significance_pvalue <- as.numeric(as.character(ilincs_signatureData$Significance_pvalue))
ilincs_signatureData[order(ilincs_signatureData$Significance_pvalue) , ]
```

## Getting volcano plot
```{r}
apiUrl <- paste("http://www.ilincs.org/api/ilincsR/volcanoPlot?file=",ilincs_sessionId,".xls",sep="")
req <- GET(apiUrl)
l <- lapply(content(req), function(x) unlist(x))
ilincs_result <- data.frame(t(sapply(l,c)))
ilincs_volcanoUrl <- ilincs_result$url
ilincs_volcanoUrl <- paste("http://www.ilincs.org",ilincs_volcanoUrl,sep="")
# ilincs_volcanoUrl
```

```{r echo=FALSE, out.width='100%'}
# knitr::include_graphics('http://eh3.uc.edu/tmp/gseaPlot_Fri_Nov_16_16_38_16_2018_257492.png')
download.file(ilincs_volcanoUrl,'volcano.png', mode = 'wb')
include_graphics('volcano.png')
```

## Get connected signatures

http://www.ilincs.org/api/SignatureMeta/findConcordantSignatures?sigID=LINCSKD_1&lib=LIB_5

```{r}
apiUrl <- paste("http://www.ilincs.org/api/SignatureMeta/findConcordantSignatures?sigID=",ilincs_signatureId,"&lib=LIB_6",sep="")
req <- GET(apiUrl)
apiUrl
json <- httr::content(req, as = "text")
ilincs_connectedSignatures <- fromJSON(json)
ilincs_connectedSignatures$similarity <- as.numeric(as.character(ilincs_connectedSignatures$similarity))
ordered_connectedSignatures <- ilincs_connectedSignatures[order(ilincs_connectedSignatures$similarity) , ]
most_discordant_signature <- ordered_connectedSignatures[1,"signatureid"]
most_discordant_signature
```

## Get correlation plot
<!-- http://www.ilincs.org/api/ilincsR/correlationPlot?sigID=LINCSCP_10270&sigFile=sig_Tue_Nov_27_13_21_36_2018_9007331.xls -->

```{r correlation plot}
# apiUrl <- "http://www.ilincs.org/api/ilincsR/correlationPlot?sigID=LINCSCP_10270&sigFile=sig_Tue_Nov_27_13_21_36_2018_9007331.xls"
# # req <- GET(apiUrl)
# # json <- httr::content(req, as = "text")
# # json <- fromJSON(apiUrl)
# # all.equal(plot, toJSON(fromJSON(apiUrl)))
# json <- toJSON(fromJSON(apiUrl))
# prettify(json)
# class(json)
# # plotly_build(json)
# # explorePlot = plotly_json(fromJSON(json))
# # plotly_build(explorePlot)
# # # correlation_plot <- fromJSON(json)
# # correlation_plot
# apiUrl <- "http://www.ilincs.org/api/ilincsR/correlationPlot?sigID=LINCSCP_10270&sigFile=sig_Tue_Nov_27_13_21_36_2018_9007331.xls&output=widget"
apiUrl <- paste("http://www.ilincs.org/api/ilincsR/correlationPlot?sigID=",most_discordant_signature,"&sigFile=",ilincs_sessionId,".xls&output=widget",sep="")
req <- GET(apiUrl)
corrPlotUrl <- content(req)$url
corrPlotUrl
# htmltools::includeHTML(corrPlotUrl)

# rmarkdown::all_output_formats(knitr::current_input())
# if ("html_document" %in% rmarkdown::all_output_formats(knitr::current_input())) {
if(getOutputFormat() == 'html_document') {
  include_url(corrPlotUrl, height = "680px")
} else {
  print("output is not HTML")
  print(getOutputFormat())
  corrPlotUrl
}
```

## Group analysis of top 20 most connected signatures with signature of interest
```{r signature group analysis}
most_concordant_20signatures <- ilincs_connectedSignatures[1:20,"signatureid"]
signaturesForGroupAnalysis21 <- c(ilincs_signatureId,most_concordant_20signatures)
r <- POST("http://www.ilincs.org/api/ilincsR/GroupLincsAnalysis", body = list(idList = signaturesForGroupAnalysis21,noOfGenes = 50), encode = "json")
ilincs_result <- content(r)$data
groupAnalysisSessionID <- ilincs_result[[2]]
groupAnalysisSessionID
```
### [Signature group heatmap on iLINCS](http://www.ilincs.org/apps/heatmap/?sessionID=`r groupAnalysisSessionID`&property=signatureID)

```{r, out.width="910px"}
heatmap_url<-paste("http://www.ilincs.org/apps/heatmap/?sessionID=",groupAnalysisSessionID,"&property=signatureID&geneCount=100",sep = "")
include_url(heatmap_url, height = "900px")
```

### [Signature group PCA and tSNE app on iLINCS](http://www.ilincs.org/apps/pca/?sessionID=`r groupAnalysisSessionID`&property=signatureID)

```{r, out.width="910px"}
pca_url<-paste("http://www.ilincs.org/apps/pca/?sessionID=",groupAnalysisSessionID,"&property=signatureID&geneCount=100",sep = "")
include_url(pca_url, height = "900px")
```

## Get connected perturbations

http://www.ilincs.org/api/ilincsR/signatureEnrichment?sigFile=sig_Tue_Nov_27_13_21_36_2018_9007331.xls&library=LIB_5

## Get connected perturbations

http://www.ilincs.org/api/ilincsR/signatureEnrichment?sigFile=sig_Tue_Nov_27_13_21_36_2018_9007331.xls&library=LIB_5

## Get GSEA plot
```{r GSEA}
apiUrl <- "http://www.ilincs.org/api/ilincsR/plotGSEA"
req <- POST(apiUrl, body = list(signatureId = paste(ilincs_signatureId),genes = c(51474,7112,8570,55421,283337,54386,5214,79894,6136,5514,5170,6197,2321), output="png"), encode = "json")
gseaPlotPng <- content(req)$fileName
gseaPlotUrl <- paste("http://www.ilincs.org/tmp/",gseaPlotPng,".png",sep="")
gseaPlotUrl
download.file(gseaPlotUrl,'GSEA.png', mode = 'wb')
include_graphics('GSEA.png')
```



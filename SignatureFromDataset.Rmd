---
title: "iLINCS API R Notebook - Creating a signature from dataset"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

## Prerequisites 

```{r}
library(knitr)
library(tinytex)
library(httr)
library(jsonlite)
library(plotly)
```

### List of LINCS Datasets
```{r}
apiUrl <- "http://www.ilincs.org/api/PublicDatasets/getDatasets?lincs=true"
req <- GET(apiUrl)
json <- httr::content(req, as = "text")
lincs_datasets <- fromJSON(json)
lincsDatasets <- data.frame(lincs_datasets$data)
lincsDatasets[c("experiment","assay","dataType")]
```


### Dataset metadata

**Example:** EDS-1014  
```{r}
experiment <- "EDS-1014"

apiUrl <- paste("http://www.ilincs.org/api/PublicDatasets/",experiment,sep="")
req <- GET(apiUrl)
json <- httr::content(req, as = "text")
datasetMetaData <- fromJSON(json)
# datasetMetaData <- data.frame(datasetMeta)
datasetMetaData
```

[Heatmap for dataset `r experiment` on iLINCS](http://www.ilincs.org/apps/heatmap/?data_set=`r experiment`)

[PCA and tSNE for dataset `r experiment` on iLINCS](http://www.ilincs.org/apps/pca/?data_set=`r experiment`)

### Dataset sample metadata

```{r}
apiUrl <- paste("http://www.ilincs.org/api/ilincsR/getSamples?id=",experiment,sep="")
req <- GET(apiUrl)
json <- httr::content(req, as = "text")
sampleMeta <- fromJSON(json)
sampleMetaData <- data.frame(sampleMeta$data$rows)
sampleMetaData
# sampleMetaData[c("experiment","assay","dataType")]
```

##Creating signature using iLINCS 
[Create signature from dataset `r experiment` on iLINCS](http://www.ilincs.org/ilincs/dataset/`r experiment`/createSignature)

##Creating signature using iLINCS API
```{r Created Signature}
property <- "ER"
level1 <- "ER:+"
level2 <- "ER:-"
apiUrl <- "http://www.ilincs.org/api/ilincsR/LincsDataAnalysis"
req <- POST(apiUrl, body = list(exp = paste(experiment),prop = property,filterchk=paste(level1,level2,sep = ",,,"),includeORexclude=1), encode = "json")
createdSignaturesSessionID <- content(req)$sessionID
createdSignaturesSessionID
# gseaPlotUrl <- paste("http://www.ilincs.org/tmp/",gseaPlotPng,".png",sep="")
# gseaPlotUrl
# download.file(gseaPlotUrl,'GSEA.png', mode = 'wb')
# include_graphics('GSEA.png')
```

##Top 100 genes in created signature
```{r top 100 genes in signature}
# signatureData <- as.data.frame(content(req)$geneData)
# signatureData
l <- lapply(content(req)$geneData, function(x) unlist(x))
ilincs_result <- data.frame(t(sapply(l,c)))
# ilincs_result
top100signatureData <- ilincs_result[1:100,c("Name_GeneSymbol","Value_LogDiffExp","Significance_pvalue")]
top100signatureData
```

### Heatmap

```{r, out.width="910px"}
heatmap_url<-paste("http://www.ilincs.org/apps/heatmap/?sessionID=",createdSignaturesSessionID,"&property=",property,"&geneCount=100",sep = "")
include_url(heatmap_url, height = "900px")
```

<!-- ### `r heatmap_url` -->

####[Heatmap in iLINCS](`r heatmap_url`)

<!-- ## Getting volcano plot -->
```{r echo=FALSE}
apiUrl <- paste("http://www.ilincs.org/api/ilincsR/volcanoPlot?file=completeSig_",createdSignaturesSessionID,".xls",sep="")
# volcanoPlot is not reading completeSig_ files to many columns
# req <- GET(apiUrl)
# l <- lapply(content(req), function(x) unlist(x))
# ilincs_result <- data.frame(t(sapply(l,c)))
# ilincs_volcanoUrl <- ilincs_result$url
# ilincs_volcanoUrl <- paste("http://www.ilincs.org",ilincs_volcanoUrl,sep="")
```
```{r echo=FALSE, out.width='100%'}
# download.file(ilincs_volcanoUrl,'volcano.png', mode = 'wb')
# include_graphics('volcano.png')
```
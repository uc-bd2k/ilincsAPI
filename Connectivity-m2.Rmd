---
title: "iLINCS API R Notebook"
output:
  html_document:
    df_print: paged
  html_notebook: default
  word_document: default
  pdf_document: default
---

<!-- ## Prerequisites  -->

```{r include = FALSE}
library(knitr)
library(tinytex)
library(httr)
library(jsonlite)
library(plotly)
library(htmltools)

getOutputFormat <- function() {
  output <- rmarkdown:::parse_yaml_front_matter(
    readLines(knitr::current_input())
    )$output
  if (is.list(output)){
    return(names(output)[1])
  } else {
    return(output[1])
  }
}
```


## Display Signature Libraries

```{r}
apiUrl <- "http://www.ilincs.org/api/SignatureLibraries"
req <- GET(apiUrl)
json <- httr::content(req, as = "text")
ilincs_libraries <- fromJSON(json)
ilincs_libraries[,c("libraryID","libraryName")]
```

## Searching for signature using BROAD ID

Searching for signature for given term. In this example "Diclofenac" coumpound will be shown as an example.

**Term :** Diclofenac
```{r}
term <- "Diclofenac"
apiUrl <- paste("http://www.ilincs.org/api/SignatureMeta/findTermWithSynonyms?term=",term,"&library=LIB_5",sep="")
req <- GET(apiUrl)

ilincs_result <- lapply(httr::content(req)$data,unlist)
ilincs_result_df<-t(data.frame(lapply(ilincs_result,function(x) {
  if(length(x)<18)x<-c(x,is_examplar=0)
  x}),stringsAsFactors = F))
rownames(ilincs_result_df)<-NULL

head(ilincs_result_df[,c("cellline","compound","concentration","signatureid","is_exemplar")])
```

#Selecting a signature to analyze

```{r selectedSignature}
ilincs_signatureId <- ilincs_result_df[1,"signatureid"]
ilincs_signatureId
```

## Getting signature data and vulcano plot
#The first step is to retrieve the session id for creation of the signature data table
```{r}
req <- POST("http://www.ilincs.org/api/ilincsR/downloadSignature", body = list(sigID = paste(ilincs_signatureId)), encode = "json")
ilincs_sessionId<-unlist(content(req))
ilincs_sessionId
```

# Retrieving data
```{r}
fileUrl=paste("http://www.ilincs.org/tmp/",ilincs_sessionId,".xls",sep="")
signatureData<-read.table(fileUrl,sep="\t",header=T,stringsAsFactors = F)
head(signatureData)
```

# Insert volcano plot
```{r}
apiUrl <- paste("http://www.ilincs.org/api/ilincsR/volcanoPlot?file=",ilincs_sessionId,".xls",sep="")
req <- GET(apiUrl)
ilincs_volcanoUrl<-paste("http://www.ilincs.org",content(req)$url,sep="")
knitr::include_graphics(ilincs_volcanoUrl)
```


## Get connected signatures

http://www.ilincs.org/api/SignatureMeta/findConcordantSignatures?sigID=LINCSKD_1&lib=LIB_5

## Get connected perturbations

http://www.ilincs.org/api/ilincsR/signatureEnrichment?sigFile=sig_Tue_Nov_27_13_21_36_2018_9007331.xls&library=LIB_5

## Get connected perturbations

http://www.ilincs.org/api/ilincsR/signatureEnrichment?sigFile=sig_Tue_Nov_27_13_21_36_2018_9007331.xls&library=LIB_5

## Get correlation plot
http://www.ilincs.org/api/ilincsR/correlationPlot?sigID=LINCSCP_10270&sigFile=sig_Tue_Nov_27_13_21_36_2018_9007331.xls

```{r correlation plot}
# apiUrl <- "http://www.ilincs.org/api/ilincsR/correlationPlot?sigID=LINCSCP_10270&sigFile=sig_Tue_Nov_27_13_21_36_2018_9007331.xls"
# # req <- GET(apiUrl)
# # json <- httr::content(req, as = "text")
# # json <- fromJSON(apiUrl)
# # all.equal(plot, toJSON(fromJSON(apiUrl)))
# json <- toJSON(fromJSON(apiUrl))
# prettify(json)
# class(json)
# # plotly_build(json)
# # explorePlot = plotly_json(fromJSON(json))
# # plotly_build(explorePlot)
# # # correlation_plot <- fromJSON(json)
# # correlation_plot
apiUrl <- "http://www.ilincs.org/api/ilincsR/correlationPlot?sigID=LINCSCP_10270&sigFile=sig_Tue_Nov_27_13_21_36_2018_9007331.xls&output=widget"
req <- GET(apiUrl)
corrPlotUrl <- content(req)$url
corrPlotUrl
# htmltools::includeHTML(corrPlotUrl)

# rmarkdown::all_output_formats(knitr::current_input())
# if ("html_document" %in% rmarkdown::all_output_formats(knitr::current_input())) {
if(getOutputFormat() == 'html_document') {
  include_url(corrPlotUrl, height = "680px")
} else {
  print("output is not HTML")
  print(getOutputFormat())
  corrPlotUrl
}
```

## Get GSEA plot
```{r GSEA}
apiUrl <- "http://www.ilincs.org/api/ilincsR/plotGSEA"
req <- POST(apiUrl, body = list(signatureId = paste(ilincs_signatureId),genes = c(51474,7112,8570,55421,283337,54386,5214,79894,6136,5514,5170,6197,2321), output="widget"), encode = "json")
gseaPlotUrl <- content(req)
gseaPlotUrl
# htmltools::includeHTML(corrPlotUrl)


# if ("html" %in% rmarkdown::all_output_formats(knitr::current_input())) {
#   include_url(gseaPlotUrl, height = "680px")
# } else {
#   gseaPlotUrl
# }
```

## Retriving Signature Metadata
```{r}
apiUrl <- paste("http://www.ilincs.org/api/SignatureMeta/",ilincs_signatureId,sep="")
req <- GET(apiUrl)
l <- lapply(content(req), function(x) unlist(x))
ilincs_result <- data.frame(t(sapply(l,c)))
knitr::kable(t(ilincs_result))
```



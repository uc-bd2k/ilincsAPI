---
title: "iLINCS API R Notebook"
output:
  html_document:
    df_print: paged
  html_notebook: default
  word_document: default
  pdf_document: default
---

<!-- ## Prerequisites  -->

```{r include = FALSE}
library(knitr)
library(tinytex)
library(httr)
library(jsonlite)
library(plotly)
library(htmltools)
```


## Display Signature Libraries

```{r list signature libraries}
apiUrl <- "http://www.ilincs.org/api/SignatureLibraries"
req <- GET(apiUrl)
json <- httr::content(req, as = "text")
ilincs_libraries <- fromJSON(json)
ilincs_libraries[,c("libraryID","libraryName")]
```

## Searching for signature using BROAD ID
###Searching for signature for given term. In this example "Diclofenac" coumpound will be shown as an example.

```{r search signatures}
term <- "Diclofenac"
ilincs_libId<-"LIB_5"
apiUrl <- paste("http://www.ilincs.org/api/SignatureMeta/findTermWithSynonyms?term=",term,"&library=",ilincs_libId,sep="")
req <- GET(apiUrl)

ilincs_result_df<-fromJSON(httr::content(req,type="text"))$data
head(ilincs_result_df[,c("cellline","compound","concentration","signatureid","is_exemplar")])
```

###Selecting a signature to analyze

```{r selectedSignature}
ilincs_signatureId <- ilincs_result_df[1,"signatureid"]
ilincs_signatureId
```

## Getting signature data and vulcano plot
###The first step is to retrieve the session id for creation of the signature data table
```{r retrieve signature data}
req <- POST("http://www.ilincs.org/api/ilincsR/downloadSignature", body = list(sigID = paste(ilincs_signatureId)), encode = "json")
ilincs_sessionId<-unlist(content(req))
ilincs_sessionId
```

### Retrieving data
```{r volcano data}
fileUrl=paste("http://www.ilincs.org/tmp/",ilincs_sessionId,".xls",sep="")
signatureData<-read.table(fileUrl,sep="\t",header=T,stringsAsFactors = F)
head(signatureData)
```

### Insert volcano plot
```{r volcano plot}
apiUrl <- paste("http://www.ilincs.org/api/ilincsR/volcanoPlot?file=",ilincs_sessionId,".xls",sep="")
req <- GET(apiUrl)
ilincs_volcanoUrl<-paste("http://www.ilincs.org",content(req)$url,sep="")
knitr::include_graphics(ilincs_volcanoUrl)
```

## Get connected signatures
```{r connected signatures}
apiUrl <- paste("http://www.ilincs.org/api/SignatureMeta/findConcordantSignatures?sigID=",ilincs_signatureId,"&lib=",ilincs_libId,sep="")
req <- GET(apiUrl)
# prettify(content(req,type="text"))
ilincs_conn_df<-fromJSON(httr::content(req,type="text"))
head(ilincs_conn_df)
```
##Find LINCS signatures connected to user a submitted signature
###Creating user submitted signature in the form of a gene list
```{r subsetting signature}
# top100signature <- signatureData[order(signatureData$Significance_pvalue)[1:100],c("Name_GeneSymbol","Value_LogDiffExp","Significance_pvalue")]
top100signature <- signatureData[order(signatureData$Significance_pvalue)[1:100],]
head(top100signature)
```

### Uploading signature as a list genes for enrichment
```{r}
apiUrl="http://www.ilincs.org/api/ilincsR/findConcordancesSC"
req <- POST(apiUrl, body = list(mode="geneList",metadata=TRUE,signatureProfile = list(genes=top100signature$Name_GeneSymbol)),encode = "json")
ilincsEnrichedSignatures <- data.table::rbindlist(content(req)$sigScores, use.names = TRUE, fill = TRUE)
head(ilincsEnrichedSignatures)
```
## Get GSEA plot
```{r GSEA}
apiUrl <- "http://www.ilincs.org/api/ilincsR/plotGSEA"
req <- POST(apiUrl, body = list(signatureId = ilincs_signatureId,genes = top100signature$ID_geneid, output="png"), encode = "json")

gseaPlotPng <- content(req)$fileName
gseaPlotUrl <- paste("http://www.ilincs.org/tmp/",gseaPlotPng,".png",sep="")
include_graphics(gseaPlotUrl)
```


##Signature as a list of up and down genes
```{r up and down genes}
apiUrl="http://www.ilincs.org/api/ilincsR/findConcordancesSC"

topUpRegulatedGenes <- list(genesUp=top100signature$Name_GeneSymbol[top100signature$Value_LogDiffExp > 0])
topDownregulatedGenes <- list(genesDown=top100signature$Name_GeneSymbol[top100signature$Value_LogDiffExp < 0])

req <- POST("http://www.ilincs.org/api/ilincsR/findConcordancesSC", body = list(mode="UpDn",metadata=TRUE,signatureProfile = c(topUpRegulatedGenes, topDownregulatedGenes)),encode = "json")

ilincsUpDnConnectedSignatures <- data.table::rbindlist(content(req)$concordanceTable, use.names = TRUE, fill = TRUE)
head(ilincsUpDnConnectedSignatures)
```

## Uploading signature profile using 100 most significant genes
```{r}
apiUrl<-"http://www.ilincs.org/api/ilincsR/findConcordancesSC"
req <- POST(apiUrl, body = list(mode="fullSig",metadata=TRUE,signatureProfile = list(fullSig = top100signature[,c("Name_GeneSymbol","Value_LogDiffExp","Significance_pvalue")])),encode = "json")

connectedSignatures<-fromJSON(httr::content(req,type="text"))
head(connectedSignatures)

ilincsConnectedSignatures <- data.table::rbindlist(req$concordanceTable, use.names = TRUE, fill = TRUE)
ilincsConnectedSignatures
```


##Find connected signatures based on user submitted full signature
###Creating a file to upload from previouslsy downloaded signature file
```{r}
write.table(signatureData,file="sigFile.tsv",sep="\t",row.names=F,col.names = T,quote=F)
system(paste("head sigFile.tsv"))
```

###Upload the file
```{r}
sigFile <- "sigFile.tsv"
processFile <- content(POST("http://www.ilincs.org/api/SignatureMeta/upload", body=list(file=upload_file(sigFile))))
signatureFile <- processFile$status$fileName[[1]]
signatureFile
```
###Find connected signatures
```{r}
apiUrl <- "http://www.ilincs.org/api/ilincsR/findConcordances"
req <- (POST(apiUrl, body = list(file=signatureFile, lib="LIB_5", path="/mnt/raid/tmp/"), encode = "form"))
output <- data.table::rbindlist(content(req)$concordanceTable, use.names = TRUE, fill = TRUE)
head(output)
```
## Find connected compound perturbations
```{r connected compound perturbations}
apiUrl <- paste("http://www.ilincs.org/api/ilincsR/signatureEnrichment?sigFile=",signatureFile,"&library=LIB_5&metadata=TRUE",sep="")
req <- GET(apiUrl)
json <- httr::content(req, as = "text")
iLincsConnectedCompoundPerturbations <- fromJSON(json)$enrichment
head(iLincsConnectedCompoundPerturbations)
```
## Get connected genetic perturbations

```{r connected genetic perturbations}
apiUrl <- paste("http://www.ilincs.org/api/ilincsR/signatureEnrichment?sigFile=",signatureFile,"&library=LIB_6",sep="")
req <- GET(apiUrl)
json <- httr::content(req, as = "text")
iLincsConnectedGeneticPerturbations <- fromJSON(json)$enrichment
head(iLincsConnectedGeneticPerturbations)
```



## Retriving Signature Metadata
```{r}
apiUrl <- paste("http://www.ilincs.org/api/SignatureMeta/",ilincs_signatureId,sep="")
req <- GET(apiUrl)
l <- lapply(content(req), function(x) unlist(x))
ilincs_result <- data.frame(t(sapply(l,c)))
ilincsSigMetaData<-fromJSON(content(req,type="text"))
t(ilincs_result)
```


